<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <title>Image Gallery and uploader</title>
    <link href="https://cdn.jsdelivr.net/npm/lightgallery.js@1.4.0/src/css/lightgallery.css" rel="stylesheet" type="text/css" />
    <link href="/styles/load-awesome.css" rel="stylesheet" type="text/css" />
    <link href="/styles/app.css" rel="stylesheet" type="text/css" />
  </head>
  <body>
    <button class="btn-upload js-btn-upload">+</button>
    <div class="js-loader loader">
      <div class="la-ball-climbing-dot la-dark la-2x">
        <div></div>
        <div></div>
        <div></div>
        <div></div>
      </div>
    </div>

    <div class="wrapper">
      <header>
        <h1>Image Gallery and uploader</h1>
      </header>
        <div id="uploader" class="uploader"></div>
        <div class="js-images images"></div>

        <script src="js/services/upload-photo.js"></script>
        <script src="js/services/image-fetcher.js"></script>
        <script src="js/modules/concurrent-task-runner.js"></script>
        <script src="js/modules/image-uploader.js"></script>
        <script src="https://unpkg.com/@eardi/vanilla-js-sidebar@0.5.3/src/sidebar.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/lightgallery.js@1.4.0/dist/js/lightgallery.min.js"></script>

        <script>
          (() => {
            function renderImages(imageUrls) {
              const imagesContainer = document.querySelector('.js-images');
              imageUrls.forEach(url => {
                const imageLink = document.createElement('a');
                imageLink.href= url;
                imageLink.className = 'image';

                if (imagesContainer.children.length > 0) {
                  imagesContainer.insertBefore(imageLink, imagesContainer.firstChild);
                } else {
                  imagesContainer.appendChild(imageLink)
                }

                imageLink.style.backgroundImage = `url(${url})`;
                imageLink.style.backgroundPosition = 'center';
                imageLink.style.backgroundSize = 'cover';
              });
            }

            async function init() {
              const uploaderContainerEl = document.getElementById('uploader');
              const imagesContainer = document.querySelector('.js-images');

              const sidebar = new Sidebar({
                direction: Sidebar.direction.TOP
              });

              const uploadTaskRunner = new ConcurrentTaskRunner({
                concurrency: 10
              });

              const uploader = new ImageUploader({
                containerEl: uploaderContainerEl,
                async onFilesSelected(files) {
                  uploader.setUploadStatus({ isUploading: true });
                  let filesToUpload = Array.from(files);
                  let filesUploaded = 0;
                  const filesToUploadCount = filesToUpload.length;

                  const doUploadImages = () => {
                    return new Promise((resolve, reject) => {
                      uploadTaskRunner.onComplete = async (tasks) => {
                        resolve();
                      };

                      uploadTaskRunner.enqueue(filesToUpload.map(async (file) => {
                        const url = await getUploadSignedRequest(file);
                        renderImages([url]);

                        filesUploaded += 1;
                        filesToUpload.splice(filesToUpload.indexOf(file), 1);
                        uploader.setUploadStatus({ text: `Uploaded ${filesUploaded} from ${filesToUploadCount} images` });
                      }));
                    });
                  };

                  const handleUpload = async () => {
                    const handleGoesBackToOnline = async (event) => {
                      await handleUpload();
                    };

                    window.addEventListener('online', handleGoesBackToOnline, { once: true });

                    await doUploadImages();
                    lightGallery(imagesContainer);

                    window.removeEventListener('online', handleGoesBackToOnline);

                    uploader.setUploadStatus({ isUploading: false });
                    sidebar.hide();
                  };

                  await handleUpload();
                }
              });

              sidebar.renderContent(uploaderContainerEl);
              uploader.render();

              // Show uploader when button is clicked
              document.querySelector('.js-btn-upload').onclick = () => sidebar.show();

              renderImages(await fetchImages());
              lightGallery(imagesContainer);
            }

            document.addEventListener('DOMContentLoaded', async () => {
              await init();

              setTimeout(() => {
                document.querySelector('.js-loader').classList.add('loader--is-hidden');
              }, 400);
            });
          })();
        </script>
  </body>
</html>
